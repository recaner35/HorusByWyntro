<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Final Flasher</title>
    <style>
        body { background: #222; color: #ddd; font-family: sans-serif; padding: 20px; text-align: center; }
        .container { background: #333; max-width: 500px; margin: 0 auto; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h2 { color: #4db8ff; margin-top: 0; }
        button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-con { background: #007bff; color: white; }
        .btn-flash { background: #28a745; color: white; }
        .btn-erase { background: #dc3545; color: white; margin-bottom: 5px; }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        #log { background: #000; color: #0f0; height: 200px; overflow-y: scroll; text-align: left; padding: 10px; font-family: monospace; font-size: 12px; margin-top: 15px; border: 1px solid #555; }
        .group { margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ESP32 Kesin Ã‡Ã¶zÃ¼m AracÄ±</h2>

    <div class="group">
        <button id="btnConnect" class="btn-con">1. CÄ°HAZA BAÄžLAN</button>
    </div>

    <div class="group" id="controls" style="opacity: 0.4; pointer-events: none;">
        <p style="margin:5px 0; font-weight:bold;">Ã–nce Dosya SeÃ§:</p>
        <input type="file" id="fileInput" accept=".bin" style="margin-bottom: 15px;">
        
        <p style="margin:5px 0; font-weight:bold; color:#ff8888;">Hata alÄ±yorsanÄ±z Ã¶nce buna basÄ±n:</p>
        <button id="btnErase" class="btn-erase">Ã‡Ä°PÄ° TAMAMEN SÄ°L (ERASE)</button>
        
        <p style="margin:5px 0; font-weight:bold;">Sonra YÃ¼kleyin:</p>
        <button id="btnFlash" class="btn-flash">FACTORY.BIN YÃœKLE</button>
    </div>

    <div id="log">Sistem hazÄ±r...</div>
</div>

<script type="module">
    // Spacehuhn'dan farklÄ± olarak, doÄŸrudan modern modÃ¼lÃ¼ Ã§ekiyoruz.
    // Bu sayede "undefined" hatasÄ± almazsÄ±nÄ±z.
    import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js/bundle.js';

    let device = null;
    let transport = null;
    let esploader = null;

    const logEl = document.getElementById("log");
    const controls = document.getElementById("controls");
    
    const log = (msg) => {
        logEl.innerHTML += msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
    };

    // BAÄžLAN BUTONU
    document.getElementById("btnConnect").onclick = async () => {
        if (!navigator.serial) return alert("Web Serial desteklenmiyor. Chrome kullanÄ±n.");

        try {
            device = await navigator.serial.requestPort();
            transport = new Transport(device);
            log("Port seÃ§ildi. BaÄŸlantÄ± kuruluyor...");

            // UI gÃ¼ncellemesi iÃ§in terminal wrapper
            const term = { clean:()=>{}, writeLine:(s)=>log(s), write:(s)=>log(s) };

            try {
                // Loader'Ä± baÅŸlatÄ±yoruz
                esploader = new ESPLoader(transport, 115200, term);
                
                log("ESP32 Boot moduna alÄ±nÄ±yor...");
                await esploader.main_fn();
                await esploader.flash_id(); // Ã‡ip bilgisini al

                log("âœ… BAÄžLANDI! Ã‡ip: " + await esploader.chip_name);
                
                // ArayÃ¼zÃ¼ aÃ§
                document.getElementById("btnConnect").textContent = "BAÄžLI";
                document.getElementById("btnConnect").disabled = true;
                controls.style.opacity = "1";
                controls.style.pointerEvents = "auto";

            } catch(e) {
                log("âŒ BAÄžLANTI HATASI: " + e.message);
                log("ðŸ‘‰ Ä°PUCU: Kabloyu Ã§Ä±karÄ±p takÄ±n ve BOOT tuÅŸuna basÄ±lÄ± tutarak tekrar deneyin.");
            }

        } catch (e) {
            log("Hata: " + e.message);
        }
    };

    // SÄ°LME BUTONU (ERASE)
    document.getElementById("btnErase").onclick = async () => {
        if(!confirm("TÃ¼m veriler silinecek. Emin misiniz?")) return;
        try {
            document.getElementById("btnErase").disabled = true;
            log("ðŸ§¹ SÄ°LÄ°NÄ°YOR (ERASE)... LÃ¼tfen bekleyin...");
            await esploader.erase_flash();
            log("âœ… SÄ°LME TAMAMLANDI!");
        } catch(e) {
            log("Silme HatasÄ±: " + e.message);
        } finally {
            document.getElementById("btnErase").disabled = false;
        }
    };

    // YÃœKLEME BUTONU (FLASH)
    document.getElementById("btnFlash").onclick = async () => {
        const fileInput = document.getElementById("fileInput");
        if (!fileInput.files[0]) return alert("Dosya seÃ§mediniz!");

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
            const data = e.target.result;
            try {
                document.getElementById("btnFlash").disabled = true;
                log("ðŸ“¦ YÃ¼kleme baÅŸlÄ±yor...");

                const fileArray = [{ data: new Uint8Array(data), address: 0x0000 }];

                await esploader.write_flash({
                    fileArray: fileArray,
                    flash_size: "keep",
                    flash_mode: "keep",
                    flash_freq: "keep",
                    erase_all: false, // Manuel sildik zaten
                    compress: true,
                    reportProgress: (fileIndex, written, total) => {
                        log(`YÃ¼kleniyor: %${Math.round((written/total)*100)}`);
                    }
                });

                log("ðŸŽ‰ Ä°ÅžLEM BAÅžARILI! Cihaz resetleniyor...");
                
                // RESET KOMUTU
                await transport.setDTR(false);
                await transport.setRTS(true);
                await new Promise(r => setTimeout(r, 100));
                await transport.setRTS(false);
                
                log("Bitti. CihazÄ±nÄ±z factory ayarlarÄ±yla aÃ§Ä±lÄ±yor.");

            } catch (e) {
                log("YÃ¼kleme HatasÄ±: " + e.message);
            } finally {
                document.getElementById("btnFlash").disabled = false;
            }
        };
        reader.readAsArrayBuffer(file);
    };
</script>

</body>
</html>
