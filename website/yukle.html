<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Horus Web Flasher</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
 import { ESPLoader, Transport } from "https://espressif.github.io/esptool-js/esptool-bundle.js";
 window.ESPLoader = ESPLoader;
 window.Transport = Transport;
</script>

<style>
body {
 font-family: Arial, sans-serif;
 background: #0f172a;
 color: #e5e7eb;
 display: flex;
 justify-content: center;
 align-items: center;
 height: 100vh;
 margin: 0;
}
.card {
 background: #020617;
 width: 520px;
 padding: 24px;
 border-radius: 14px;
 box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}
h2 { margin-top: 0; }
button {
 width: 100%;
 padding: 12px;
 margin-top: 10px;
 border-radius: 8px;
 border: none;
 background: #2563eb;
 color: white;
 font-weight: bold;
 cursor: pointer;
 transition: background 0.2s;
}
button:hover:not(:disabled) { background: #1d4ed8; }
button:disabled { opacity: .4; cursor: not-allowed; }
#log, #serial {
 background: #000;
 font-family: 'Courier New', monospace;
 font-size: 12px;
 padding: 10px;
 margin-top: 10px;
 height: 120px;
 overflow-y: auto;
 border-radius: 6px;
 white-space: pre-wrap;
 border: 1px solid #334155;
}
.small { font-size: 12px; color: #9ca3af; margin-bottom: 4px; }
.divider { text-align: center; margin: 10px 0; font-size: 12px; color: #64748b; }
</style>
</head>

<body>
<div class="card">
 <h2>Horus Web Flasher</h2>
 <div class="small" id="version">Release: latest</div>

 <button id="connectBtn">üîå Cihaza Baƒülan</button>
 <button id="githubBtn">‚¨á GitHub Latest (Factory)</button>

 <div class="divider">veya manuel dosya se√ß</div>
 <input type="file" id="fileInput" accept=".bin" style="width: 100%; color: #9ca3af;">

 <button id="flashBtn" disabled>‚ö° Flash Et</button>

 <div id="log">Logs...</div>
 <div id="serial">Serial output...</div>
</div>

<script>
const OWNER = "recaner35";
const REPO = "HorusByWyntro";
const FACTORY_URL =
 `https://github.com/${OWNER}/${REPO}/releases/latest/download/HorusByWyntro-factory.bin`;

let port, transport, esploader;
let selectedBin = null;
let selectedBinName = "";

const logBox = document.getElementById("log");
const serialBox = document.getElementById("serial");
const flashBtn = document.getElementById("flashBtn");

function log(msg) {
 logBox.innerHTML += `<div>> ${msg}</div>`;
 logBox.scrollTop = logBox.scrollHeight;
}

function serial(msg) {
 serialBox.textContent += msg;
 serialBox.scrollTop = serialBox.scrollHeight;
}

function updateFlashButton() {
 flashBtn.disabled = !selectedBin || !esploader;
 if(!flashBtn.disabled) {
  flashBtn.innerText = `‚ö° Flash Et (${selectedBinName})`;
 }
}

const terminalAdapter = {
 clean: () => { serialBox.textContent = ""; },
 writeLine: (data) => { serial(data + "\n"); },
 write: (data) => { serial(data); }
};

document.getElementById("connectBtn").onclick = async () => {
 try {
  if (!navigator.serial) {
   throw new Error("Tarayƒ±cƒ±nƒ±z Web Serial API desteklemiyor (Chrome/Edge kullanƒ±n).");
  }

  log("Port se√ßimi penceresi a√ßƒ±lƒ±yor... L√ºtfen cihazƒ±nƒ±zƒ± se√ßin.");
  port = await navigator.serial.requestPort({ filters: [{ usbVendorId: 0x10c4 }] });  // CP210x filtre ekle, daha hƒ±zlƒ± se√ßer

  if (!port) {
   throw new Error("Port se√ßilmedi veya iptal edildi.");
  }

  // Port'u a√ßmayƒ± dene (bazƒ± durumlarda getInfo √∂ncesi open gerekli)
  try {
   await port.open({ baudRate: 115200 });
   log("Port ba≈üarƒ±yla a√ßƒ±ldƒ±.");
  } catch (openErr) {
   log("Port a√ßma uyarƒ±sƒ± (devam ediyoruz): " + openErr.message);
  }

  // Info'yu g√ºvenli al
  let portInfo = "Bilinmeyen";
  try {
   const info = await port.getInfo();
   portInfo = `VID: ${info.usbVendorId?.toString(16) || '?'} PID: ${info.usbProductId?.toString(16) || '?'}`;
  } catch (e) {
   log("getInfo alƒ±namadƒ± ama devam: " + e.message);
  }
  log(`Se√ßilen port: ${portInfo}`);

  transport = new Transport(port);

  log("ESPLoader ba≈ülatƒ±lƒ±yor (d√º≈ü√ºk baud ile)...");
  // D√º≈ü√ºk baud ile ba≈üla ‚Üí stabilite artar
  esploader = new ESPLoader(transport, 115200, terminalAdapter);

  log("Chip algƒ±lama ba≈ülƒ±yor...");
  const chip = await esploader.main_fn();
  log("Baƒülandƒ±: " + chip);

  updateFlashButton();

 } catch (e) {
  console.error(e);
  log("‚ùå Baƒülantƒ± hatasƒ±: " + (e.message || String(e)));
 }
};

document.getElementById("githubBtn").onclick = async () => {
 try {
  log("Factory.bin GitHub'dan indiriliyor...");
  const res = await fetch(FACTORY_URL);
  if (!res.ok) throw new Error(`Download ba≈üarƒ±sƒ±z: ${res.status}`);

  const blob = await res.blob();
  selectedBin = await blob.arrayBuffer();
  selectedBinName = "GitHub Factory";
  
  log("Factory.bin indirildi ve hazƒ±r.");
  updateFlashButton();
 } catch (e) {
  log("GitHub hatasƒ±: " + e.message);
 }
};

document.getElementById("fileInput").onchange = async e => {
 const file = e.target.files[0];
 if (!file) return;
 
 selectedBin = await file.arrayBuffer();
 selectedBinName = file.name;
 
 log("Dosya se√ßildi: " + file.name);
 updateFlashButton();
};

flashBtn.onclick = async () => {
 if (!esploader || !selectedBin) return;

 try {
  log("Flash i≈ülemi ba≈ülƒ±yor...");
  log("L√ºtfen bekleyin, bu i≈ülem biraz s√ºrebilir.");
  
  const fileArray = [{ data: new Uint8Array(selectedBin), address: 0x0 }];

  await esploader.write_flash(
   fileArray,
   'keep', // flash_size
   'keep', // flash_mode
   'keep', // flash_freq
   false, // compress
   true // erase_all
  );

  log("‚úÖ Flash BA≈ûARIYLA tamamlandƒ±! Cihaz resetleniyor...");
  
 } catch (e) {
  console.error(e);
  log("‚ùå Flash hatasƒ±: " + e.message);
 }
};
</script>
</body>
</html>
