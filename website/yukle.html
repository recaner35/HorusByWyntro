<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Horus Factory Firmware YÃ¼kleyici</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 1rem; line-height: 1.6; background: #f9f9f9; }
    h1 { color: #1a73e8; }
    pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 8px; overflow-y: auto; max-height: 400px; font-size: 0.9rem; }
    button { padding: 0.8rem 1.6rem; margin: 0.5rem 1rem 0.5rem 0; font-size: 1.1rem; cursor: pointer; border: none; border-radius: 6px; }
    #connectBtn { background: #4285f4; color: white; }
    #flashBtn { background: #34a853; color: white; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .success { color: #34a853; font-weight: bold; }
    .error { color: #ea4335; font-weight: bold; }
    input[type="file"] { margin: 1rem 0; }
  </style>
</head>
<body>
  <h1>Horus Factory Firmware YÃ¼kleyici (Otomatik)</h1>

  <p><strong>AdÄ±mlar:</strong></p>
  <ol>
    <li>KartÄ± USB'ye takÄ±n (<strong>hiÃ§ tuÅŸa basmayÄ±n</strong> â€“ kartÄ±nÄ±z otomatik bootloader'a girer)</li>
    <li>AÅŸaÄŸÄ±dan <strong>HorusByWyntro-factory.bin</strong> dosyanÄ±zÄ± seÃ§in</li>
    <li>"ESP32'ye BaÄŸlan" â†’ port seÃ§in</li>
    <li>"YÃ¼kle (Erase + Flash)" butonuna basÄ±n</li>
  </ol>

  <input type="file" id="binFile" accept=".bin" />
  <br><br>

  <button id="connectBtn">ESP32'ye BaÄŸlan</button>
  <button id="flashBtn" disabled>YÃ¼kle (Tam Erase + Flash)</button>

  <h3>Ä°ÅŸlem Logu:</h3>
  <pre id="output">Durum: HazÄ±r... (Chrome/Edge kullanÄ±n)\n</pre>

  <script src="https://unpkg.com/esptool-js@0.2.0/dist/web/index.js"></script>
  <script>
    const binInput = document.getElementById('binFile');
    const connectBtn = document.getElementById('connectBtn');
    const flashBtn = document.getElementById('flashBtn');
    const output = document.getElementById('output');

    let transport, esploader, binArray;

    function log(msg, type = '') {
      const div = document.createElement('div');
      div.textContent = msg;
      if (type) div.className = type;
      output.appendChild(div);
      output.scrollTop = output.scrollHeight;
    }

    binInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file?.name.endsWith('.bin')) return log('GeÃ§ersiz dosya! Sadece .bin seÃ§in.', 'error');

      try {
        binArray = new Uint8Array(await file.arrayBuffer());
        log(`Dosya yÃ¼klendi: \( {file.name} ( \){(binArray.length / 1024 / 1024).toFixed(2)} MB)`, 'success');
        flashBtn.disabled = !(transport && esploader);
      } catch (err) {
        log('Dosya okuma hatasÄ±: ' + err.message, 'error');
      }
    });

    connectBtn.addEventListener('click', async () => {
      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        transport = new Transport(port);
        esploader = await ESPLoader.init(transport, {
          baudRate: 115200,
          flashMode: 'dio',
          flashFreq: '80m',
          flashSize: '4MB'
        }, console);

        log(`BaÄŸlantÄ± OK! Chip: ${esploader.chipName} â€¢ MAC: ${esploader.macAddr}`, 'success');
        connectBtn.disabled = true;
        flashBtn.disabled = !binArray;
      } catch (err) {
        log('BaÄŸlantÄ± hatasÄ±: ' + err.message + ' (Kart takÄ±lÄ± mÄ±? Bootloader modunda mÄ±?)', 'error');
      }
    });

    flashBtn.addEventListener('click', async () => {
      if (!esploader || !binArray) return log('Ã–nce baÄŸlanÄ±n ve dosya seÃ§in!', 'error');

      flashBtn.disabled = true;
      log('Ä°ÅŸlem baÅŸlÄ±yor... (3-8 dk sÃ¼rebilir, sabÄ±rlÄ± olun)');

      try {
        log('1. Tam flash siliniyor (erase chip)...');
        await esploader.eraseFlash();

        log('2. Factory.bin yazÄ±lÄ±yor (offset 0x0)...');
        await esploader.writeFlash([{ data: binArray, address: 0 }]);

        log('YÃœKLEME TAMAMLANDI! ğŸ‰ KartÄ± USB\'den Ã§Ä±karÄ±p takabilirsiniz.', 'success');
      } catch (err) {
        log('HATA: ' + err.message, 'error');
        console.error(err);
      } finally {
        flashBtn.disabled = false;
      }
    });
  </script>
</body>
</html>