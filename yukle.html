<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Horus Firmware YÃ¼kleyici v1.0.1</title>

<script src="https://unpkg.com/esptool-js@0.5.4/bundle.js"></script>

<style>
  :root {
    --bg-color: #0f172a;
    --card-bg: #1e293b;
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    --primary: #3b82f6;
    --primary-hover: #2563eb;
    --danger: #ef4444;
    --danger-hover: #dc2626;
    --success: #10b981;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-main);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }

  .container {
    background-color: var(--card-bg);
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    width: 90%;
    max-width: 600px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  h1 { margin: 0; font-size: 1.5rem; text-align: center; color: var(--primary); }
  .subtitle { text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem; }

  .status-bar {
    background: #000;
    padding: 10px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 0.85rem;
    color: var(--success);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  button {
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: white;
  }

  button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

  .btn-connect { background-color: var(--primary); grid-column: span 2; }
  .btn-connect:hover:not(:disabled) { background-color: var(--primary-hover); }

  .btn-flash { background-color: var(--success); }
  .btn-flash:hover:not(:disabled) { background-color: #059669; }

  .btn-erase { background-color: var(--danger); }
  .btn-erase:hover:not(:disabled) { background-color: var(--danger-hover); }

  #terminal {
    background-color: #000;
    color: #33ff33;
    font-family: 'Courier New', monospace;
    padding: 1rem;
    height: 250px;
    overflow-y: auto;
    border-radius: 8px;
    font-size: 12px;
    white-space: pre-wrap;
    border: 1px solid #334155;
  }

  /* Scrollbar */
  #terminal::-webkit-scrollbar { width: 8px; }
  #terminal::-webkit-scrollbar-track { background: #000; }
  #terminal::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

  .progress-container {
    height: 6px;
    background: #334155;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 5px;
    display: none;
  }
  .progress-bar {
    height: 100%;
    background: var(--success);
    width: 0%;
    transition: width 0.3s;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Horus YÃ¼kleyici</h1>
  <div class="subtitle">Horus by Wyntro - ESP32 Firmware Manager</div>

  <div class="status-bar">
    <span id="statusText">ğŸ”´ BaÄŸlÄ± DeÄŸil</span>
    <span id="deviceInfo"></span>
  </div>

  <div class="controls">
    <button id="btnConnect" class="btn-connect" onclick="connectToDevice()">ğŸ”Œ CÄ°HAZA BAÄLAN</button>
    <button id="btnFlash" class="btn-flash" onclick="startProcess('flash')" disabled>âš¡ YÃœKLE (Latest)</button>
    <button id="btnErase" class="btn-erase" onclick="startProcess('erase')" disabled>ğŸ—‘ SÄ°L (Erase)</button>
  </div>
  
  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <div id="terminal">Terminal hazÄ±r. 'BaÄŸlan' butonuna basÄ±n...</div>
</div>

<script>
  // --- AYARLAR ---
  const GITHUB_OWNER = "recaner35";
  const GITHUB_REPO = "HorusByWyntro";
  const PROXY_URL = "https://corsproxy.io/?"; 

  // --- DEÄÄ°ÅKENLER ---
  let port;
  let esploader;
  let transport;
  let term;

  const terminal = document.getElementById("terminal");
  const btnConnect = document.getElementById("btnConnect");
  const btnFlash = document.getElementById("btnFlash");
  const btnErase = document.getElementById("btnErase");
  const statusText = document.getElementById("statusText");
  const progressBar = document.getElementById("progressBar");
  const progressContainer = document.getElementById("progressContainer");

  // --- YARDIMCI FONKSÄ°YONLAR ---
  function log(msg) {
    terminal.textContent += msg + "\n";
    terminal.scrollTop = terminal.scrollHeight;
  }

  // Esptool-js terminal adaptÃ¶rÃ¼
  const espLoaderTerminal = {
    clean: () => { terminal.textContent = ""; },
    writeLine: (data) => { log(data); },
    write: (data) => { log(data); }
  };

  // --- BAÄLANTI ---
  async function connectToDevice() {
    if (!navigator.serial) {
      alert("TarayÄ±cÄ±nÄ±z Web Serial desteklemiyor. LÃ¼tfen Chrome veya Edge kullanÄ±n.");
      return;
    }

    try {
      port = await navigator.serial.requestPort();
      transport = new Transport(port); // Resmi kÃ¼tÃ¼phaneden gelen Transport
      
      // ButonlarÄ± gÃ¼ncelle
      btnConnect.textContent = "âœ… BaÄŸlandÄ± (Port DeÄŸiÅŸtir)";
      statusText.textContent = "ğŸŸ¢ HazÄ±r";
      statusText.style.color = "#10b981";
      btnFlash.disabled = false;
      btnErase.disabled = false;
      
      log("Port seÃ§ildi. Ä°ÅŸlem bekleniyor...");
      
      // KÃ¼Ã§Ã¼k bir baÄŸlantÄ± testi ve monitÃ¶r baÅŸlatma
      await transport.connect();
      readLoop(); // Seri monitÃ¶rÃ¼ arka planda dinlemeye baÅŸla

    } catch (e) {
      log("BaÄŸlantÄ± HatasÄ±: " + e.message);
    }
  }

  // --- GITHUB'DAN DOSYA BULMA VE Ä°NDÄ°RME ---
  async function fetchLatestFirmware() {
    log("GitHub'dan son sÃ¼rÃ¼m aranÄ±yor...");
    
    try {
      // 1. Release bilgisini Ã§ek
      const apiRes = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/releases/latest`);
      if (!apiRes.ok) throw new Error("GitHub Release bilgisi alÄ±namadÄ±.");
      const releaseData = await apiRes.json();
      
      log(`Son SÃ¼rÃ¼m Bulundu: ${releaseData.tag_name}`);

      // 2. Factory.bin dosyasÄ±nÄ± bul
      const asset = releaseData.assets.find(a => a.name.endsWith("factory.bin"));
      if (!asset) throw new Error("Release iÃ§inde 'factory.bin' dosyasÄ± bulunamadÄ±.");

      log(`Ä°ndiriliyor: ${asset.name}`);
      
      // 3. DosyayÄ± indir (CORS Proxy ile)
      // fetch iÃ§indeki URL'yi proxy'ye veriyoruz
      const downloadUrl = PROXY_URL + encodeURIComponent(asset.browser_download_url);
      const binRes = await fetch(downloadUrl);
      
      if (!binRes.ok) throw new Error("Dosya indirilemedi.");
      
      const blob = await binRes.blob();
      const arrayBuffer = await blob.arrayBuffer();
      
      log(`Ä°ndirme tamamlandÄ±! Boyut: ${(arrayBuffer.byteLength / 1024).toFixed(2)} KB`);
      return arrayBuffer;

    } catch (e) {
      throw new Error("Firmware indirme hatasÄ±: " + e.message);
    }
  }

  // --- ANA Ä°ÅLEM (FLASH veya ERASE) ---
  async function startProcess(mode) {
    if (!port) return;

    // Ã–nceki okuma dÃ¶ngÃ¼sÃ¼nÃ¼ durdurmak iÃ§in sinyal gerekebilir ama
    // esptool loader baÅŸladÄ±ÄŸÄ±nda portu devralÄ±r.
    
    try {
      btnFlash.disabled = true;
      btnErase.disabled = true;
      btnConnect.disabled = true;
      progressContainer.style.display = "block";
      progressBar.style.width = "0%";

      // Loader'Ä± baÅŸlat
      // DÄ°KKAT: ESPLoader versiyonuna gÃ¶re parametre sÄ±rasÄ±: (transport, baudrate, terminal)
      esploader = new ESPLoader(transport, 921600, espLoaderTerminal); // HÄ±zlÄ± flash iÃ§in 921600

      log("Bootloader'a baÄŸlanÄ±lÄ±yor (Boot tuÅŸuna basÄ±lÄ± tutmanÄ±z gerekebilir)...");
      
      const chip = await esploader.main_fn(); 
      log(`Chip AlgÄ±landÄ±: ${chip}`);

      if (mode === 'erase') {
        log("Silme iÅŸlemi baÅŸlÄ±yor...");
        await esploader.erase_flash();
        log("âœ… Silme TAMAMLANDI!");
      } 
      else if (mode === 'flash') {
        // DosyayÄ± indir
        const fileData = await fetchLatestFirmware();
        
        log("Yazma iÅŸlemi baÅŸlÄ±yor...");
        
        const fileArray = [{ data: new Uint8Array(fileData), address: 0x0000 }];
        
        // write_flash(fileArray, flash_size, flash_mode, flash_freq, compress, erase_all)
        await esploader.write_flash(
          fileArray,
          'keep', 
          'keep', 
          'keep', 
          false, 
          true, // Erase all yapÄ±p temiz kurulum yapmak en saÄŸlÄ±klÄ±sÄ±dÄ±r
          (fileIndex, written, total) => {
            const percent = Math.round((written / total) * 100);
            progressBar.style.width = percent + "%";
            // Ã‡ok fazla log basmamak iÃ§in yÃ¼zdeyi terminale yazmÄ±yoruz, barÄ± kullanÄ±yoruz
          }
        );
        log("âœ… YÃ¼kleme TAMAMLANDI!");
      }

      // Ä°ÅŸlem bitince reset at
      log("Cihaz yeniden baÅŸlatÄ±lÄ±yor...");
      await transport.setDTR(false);
      await new Promise(r => setTimeout(r, 100));
      await transport.setDTR(true);

    } catch (e) {
      log("âŒ HATA: " + e.message);
      console.error(e);
    } finally {
      // Temizlik ve ButonlarÄ± aÃ§ma
      btnFlash.disabled = false;
      btnErase.disabled = false;
      btnConnect.disabled = false;
      esploader = null; 
      // Seri monitÃ¶re geri dÃ¶n
      readLoop();
    }
  }

  // --- SERÄ° MONÄ°TÃ–R DÃ–NGÃœSÃœ ---
  async function readLoop() {
    // EÄŸer flash iÅŸlemi yapÄ±lÄ±yorsa okumayÄ± durdurmak gerekebilir
    // Ancak basit yapÄ±da transport okumaya devam etmeye Ã§alÄ±ÅŸÄ±rsa hata verebilir.
    // Åimdilik basit bir try-catch ile yÃ¶netiyoruz.
    try {
      if (port && port.readable && !esploader) {
        const reader = port.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
              const text = new TextDecoder().decode(value);
              terminal.textContent += text;
              terminal.scrollTop = terminal.scrollHeight;
            }
          }
        } finally {
          reader.releaseLock();
        }
      }
    } catch (e) {
      // Flash sÄ±rasÄ±nda port meÅŸgul olacaÄŸÄ± iÃ§in burasÄ± hata verebilir, yoksayÄ±yoruz.
    }
    // DÃ¶ngÃ¼yÃ¼ yavaÅŸlatmak iÃ§in
    setTimeout(readLoop, 100);
  }

</script>
</body>
</html>
