<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>Horus Factory Flasher</title>

<script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
<script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/serial-console.js?module"></script>

<style>
body {
    font-family: system-ui;
    background:#f4f6fb;
    display:flex;
    justify-content:center;
    padding:30px;
}
.card {
    width:520px;
    background:#fff;
    border-radius:14px;
    box-shadow:0 10px 25px rgba(0,0,0,.1);
    padding:25px;
}
h2 { margin-top:0 }
.group {
    padding:15px;
    border-radius:10px;
    border:1px solid #ddd;
    margin-bottom:15px;
}
.primary { background:#e8f5e9;border-color:#c8e6c9 }
.secondary { background:#e3f2fd;border-color:#bbdefb }
button {
    padding:10px 16px;
    border-radius:8px;
    border:none;
    background:#1976d2;
    color:white;
    cursor:pointer;
}
button.secondary-btn { background:#455a64 }
#status { font-size:13px;margin-top:10px;font-weight:600 }
#log {
    margin-top:15px;
    height:120px;
    background:#111;
    color:#0f0;
    font-family:monospace;
    font-size:12px;
    overflow:auto;
    padding:10px;
    border-radius:8px;
}
esp-web-serial-console {
    height:180px;
    display:block;
    margin-top:15px;
    border-radius:10px;
}
small { color:#666 }
</style>
</head>

<body>
<div class="card">

<h2>Horus Factory Flasher</h2>
<small id="releaseInfo">Sürüm bilgisi alınıyor…</small>

<div class="group primary">
<b>Önerilen:</b><br>
<button id="githubBtn">GitHub Latest Yükle</button>
</div>

<div class="group secondary">
<b>Yerel factory.bin</b><br>
<input type="file" id="localFile" accept=".bin">
</div>

<esp-web-install-button id="installBtn" style="display:none"></esp-web-install-button>

<div id="status">Bağlantı bekleniyor…</div>
<div id="log"></div>

<b>Canlı Seri Monitör</b>
<esp-web-serial-console baudrate="115200"></esp-web-serial-console>

</div>

<script type="module">
const REPO = "recaner35/HorusByWyntro";
const FACTORY_URL =
`https://github.com/${REPO}/releases/latest/download/HorusByWyntro-factory.bin`;

const status = document.getElementById("status");
const logBox = document.getElementById("log");
const installBtn = document.getElementById("installBtn");
const githubBtn = document.getElementById("githubBtn");
const localFile = document.getElementById("localFile");
const releaseInfo = document.getElementById("releaseInfo");

function log(msg) {
    logBox.innerText += msg + "\n";
    logBox.scrollTop = logBox.scrollHeight;
}

/* --- GitHub Release Info --- */
fetch(`https://api.github.com/repos/${REPO}/releases/latest`)
.then(r => r.json())
.then(d => {
    releaseInfo.innerText =
      `Latest: v${d.tag_name} – ${new Date(d.published_at).toLocaleDateString()}`;
})
.catch(()=>releaseInfo.innerText="Release bilgisi alınamadı");

/* --- Manifest Oluşturucu --- */
function setManifest(path) {
    const manifest = {
        name:"Horus",
        builds:[{
            chipFamily:"ESP32",
            eraseFirst:true,
            parts:[{ path, offset:0 }]
        }]
    };

    const url =
      "data:application/json;base64," +
      btoa(unescape(encodeURIComponent(JSON.stringify(manifest))));

    installBtn.setAttribute("manifest", url);
    installBtn.style.display="inline-block";
}

/* --- GitHub Latest --- */
githubBtn.onclick = () => {
    log("GitHub latest factory.bin seçildi");
    setManifest(FACTORY_URL);
    status.innerText="Hazır – Cihazı bağlayın";
};

/* --- Local File --- */
localFile.onchange = () => {
    if(!localFile.files.length) return;
    log("Yerel factory.bin seçildi");
    setManifest(URL.createObjectURL(localFile.files[0]));
    status.innerText="Hazır – Cihazı bağlayın";
};

/* --- ESP Chip Doğrulama (Bağlantı sonrası) --- */
installBtn.addEventListener("connected", e => {
    const chip = e.detail?.chip?.chipFamily || "unknown";
    log("Cihaz bağlandı: " + chip);

    if (chip !== "ESP32") {
        alert("Bu flasher yalnızca ESP32 içindir!");
        location.reload();
    }
});

installBtn.addEventListener("install-start", ()=> {
    log("Yükleme başladı");
    status.innerText="Yazılıyor…";
});

installBtn.addEventListener("install-success", ()=> {
    log("Yükleme tamamlandı");
    status.innerText="✔ Başarılı";
});

installBtn.addEventListener("install-error", e=> {
    log("HATA: " + e.detail?.message);
    status.innerText="❌ Hata oluştu";
});
</script>
</body>
</html>
