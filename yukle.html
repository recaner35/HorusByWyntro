<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Ultimate Flasher</title>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', monospace; display: flex; flex-direction: column; align-items: center; padding: 30px; }
        .card { background: #1e1e1e; padding: 25px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); width: 100%; max-width: 550px; border: 1px solid #333; }
        h2 { color: #03dac5; margin-top: 0; text-align: center; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .btn { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-blue { background: #2979ff; color: white; }
        .btn-blue:hover { background: #2264d1; }
        .btn-red { background: #cf6679; color: black; }
        .btn-green { background: #00c853; color: white; }
        .btn:disabled { background: #333; color: #777; cursor: not-allowed; }
        #console { background: #000; color: #00ff00; height: 250px; overflow-y: auto; padding: 12px; margin-top: 20px; border-radius: 6px; border: 1px solid #333; font-size: 13px; font-family: 'Courier New', monospace; white-space: pre-wrap; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>ESP32 Kesin YÃ¼kleyici</h2>
    
    <div id="step1">
        <button id="btnConnect" class="btn btn-blue">1. CÄ°HAZA BAÄLAN</button>
    </div>

    <div id="step2" class="hidden">
        <div style="background:#332b00; padding:10px; border-radius:4px; margin-bottom:10px; font-size:0.9em; color:#ffd700;">
            âš ï¸ Ã–nemli: "Invalid Magic Byte" hatasÄ± almamak iÃ§in Ã¶nce <b>SÄ°L (ERASE)</b> yapÄ±n.
        </div>
        
        <input type="file" id="fileInput" accept=".bin" style="width:100%; padding:10px; background:#222; border:1px solid #444; margin-bottom:10px; color:white;">
        
        <button id="btnErase" class="btn btn-red">2. Ã‡Ä°PÄ° TAMAMEN SÄ°L (ERASE)</button>
        <button id="btnFlash" class="btn btn-green" disabled>3. YÃœKLE (FLASH)</button>
    </div>

    <div id="console">Sistem hazÄ±r. BaÄŸlan butonuna basÄ±n...</div>
</div>

<script type="module">
    // KÃ¼tÃ¼phaneyi doÄŸrudan URL'den import ediyoruz. Global deÄŸiÅŸkene ihtiyaÃ§ yok.
    import { ESPLoader, Transport } from 'https://unpkg.com/esptool-js@0.5.4/bundle.js';

    let device;
    let transport;
    let esploader;

    const logEl = document.getElementById("console");
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const btnConnect = document.getElementById("btnConnect");
    const btnErase = document.getElementById("btnErase");
    const btnFlash = document.getElementById("btnFlash");
    const fileInput = document.getElementById("fileInput");

    const log = (msg) => {
        logEl.innerHTML += `> ${msg}\n`;
        logEl.scrollTop = logEl.scrollHeight;
    };

    // --- 1. BAÄLAN ---
    btnConnect.onclick = async () => {
        if (!navigator.serial) return alert("Bu tarayÄ±cÄ± Web Serial desteklemiyor. Chrome kullanÄ±n.");

        try {
            device = await navigator.serial.requestPort();
            
            // --- HATA DÃœZELTÄ°CÄ° YAMA BAÅLANGICI ---
            // 'getInfo' hatasÄ±nÄ± Ã¶nlemek iÃ§in cihaz nesnesini kontrol ediyoruz
            if (!device.getInfo) {
                device.getInfo = () => ({ usbVendorId: 0, usbProductId: 0 });
            }
            // --- HATA DÃœZELTÄ°CÄ° YAMA BÄ°TÄ°ÅÄ° ---

            transport = new Transport(device);
            log("Port seÃ§ildi. Bootloader baÅŸlatÄ±lÄ±yor...");

            // UI'yÄ± log fonksiyonuna baÄŸla
            const term = { 
                clean: () => {}, 
                writeLine: (s) => log(s), 
                write: (s) => log(s) 
            };

            try {
                // Loader'Ä± baÅŸlat
                esploader = new ESPLoader(transport, 115200, term);
                
                log("ESP32 ile el sÄ±kÄ±ÅŸÄ±lÄ±yor (RTS/DTR)...");
                log("EÄŸer burada takÄ±lÄ±rsa cihazÄ±n Ã¼zerindeki BOOT tuÅŸuna basÄ±lÄ± tut!");
                
                await esploader.main_fn();
                await esploader.flash_id();

                log("âœ… BAÄLANTI BAÅARILI!");
                log("Ã‡ip Modeli: " + await esploader.chip_name);

                step1.classList.add("hidden");
                step2.classList.remove("hidden");

            } catch(e) {
                log("âŒ BAÄLANTI KOPTU: " + e.message);
                log("Ã‡Ã–ZÃœM: USB kablosunu Ã§Ä±karÄ±p takÄ±n ve tekrar deneyin.");
            }

        } catch (e) {
            log("HATA: " + e.message);
        }
    };

    // --- DOSYA SEÃ‡Ä°MÄ° ---
    fileInput.onchange = () => {
        if(fileInput.files.length > 0) {
            btnFlash.disabled = false;
            btnFlash.innerText = "3. YÃœKLE (FLASH) - HazÄ±r";
        }
    };

    // --- 2. SÄ°LME (ERASE) ---
    btnErase.onclick = async () => {
        if(!confirm("Ã‡ip tamamen silinecek ve fabrika ayarlarÄ±na dÃ¶necek. OnaylÄ±yor musunuz?")) return;
        
        try {
            btnErase.disabled = true;
            btnFlash.disabled = true;
            log("ğŸ§¹ Silme iÅŸlemi baÅŸladÄ± (15-30 saniye sÃ¼rebilir)...");
            
            await esploader.erase_flash();
            
            log("âœ… SÄ°LME TAMAMLANDI! Ã‡ip ÅŸu an bomboÅŸ.");
        } catch(e) {
            log("Silme HatasÄ±: " + e.message);
        } finally {
            btnErase.disabled = false;
            if(fileInput.files.length > 0) btnFlash.disabled = false;
        }
    };

    // --- 3. YÃœKLEME (FLASH) ---
    btnFlash.onclick = async () => {
        const file = fileInput.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = e.target.result;
            
            try {
                btnFlash.disabled = true;
                btnErase.disabled = true;
                log("ğŸ“¦ YÃ¼kleme baÅŸlÄ±yor...");

                // Factory.bin 0x0000 adresine yazÄ±lÄ±r
                const fileArray = [{ data: new Uint8Array(data), address: 0x0000 }];

                await esploader.write_flash({
                    fileArray: fileArray,
                    flash_size: "keep",
                    flash_mode: "keep",
                    flash_freq: "keep",
                    erase_all: false, // Manuel sildik zaten
                    compress: true,
                    reportProgress: (fileIndex, written, total) => {
                        const p = Math.round((written / total) * 100);
                        if(p % 10 === 0) log(`YÃ¼kleniyor: %${p}`);
                    }
                });

                log("ğŸ‰ Ä°ÅLEM BAÅARILI! Cihaz resetleniyor...");

                // CihazÄ± Resetle
                await transport.setDTR(false);
                await transport.setRTS(true);
                await new Promise(r => setTimeout(r, 100));
                await transport.setRTS(false);
                
                log("âœ… BÄ°TTÄ°. CihazÄ±nÄ±z factory.bin ile aÃ§Ä±lÄ±yor.");
                alert("YÃ¼kleme tamamlandÄ±!");

            } catch(e) {
                log("YÃ¼kleme HatasÄ±: " + e.message);
                btnFlash.disabled = false;
                btnErase.disabled = false;
            }
        };
        reader.readAsArrayBuffer(file);
    };
</script>

</body>
</html>
