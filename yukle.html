<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Horus ESP32 Firmware YÃ¼kleyici</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; line-height: 1.5; }
    pre { background: #f4f4f4; padding: 1rem; border-radius: 6px; white-space: pre-wrap; word-break: break-all; max-height: 400px; overflow-y: auto; }
    button { padding: 0.7rem 1.4rem; margin: 0.5rem 0.8rem 0.5rem 0; font-size: 1rem; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .success { color: #2e7d32; }
    .error   { color: #c62828; }
  </style>
</head>
<body>
  <h1>Horus Firmware YÃ¼kleyici (ESP32-WROOM-32D â€¢ 4MB)</h1>

  <p><strong>AdÄ±mlar:</strong></p>
  <ol>
    <li>ESP32'yi <strong>bootloader moduna</strong> alÄ±n (GPIO0 â†’ GND baÄŸlayÄ±n â†’ EN/Reset tuÅŸuna basÄ±n veya kÄ±sa devre yapÄ±n)</li>
    <li>AÅŸaÄŸÄ±dan <strong>HorusByWyntro-factory.bin</strong> dosyanÄ±zÄ± seÃ§in</li>
    <li>"ESP32'ye BaÄŸlan" butonuna basÄ±n ve tarayÄ±cÄ±dan COM portunuzu seÃ§in</li>
    <li>"Firmware'i YÃ¼kle (Erase + Flash)" butonuna basÄ±n</li>
  </ol>

  <hr>

  <label for="binFile"><strong>Factory .bin dosyasÄ±nÄ± seÃ§in:</strong></label><br>
  <input type="file" id="binFile" accept=".bin"/><br><br>

  <button id="connectBtn">ESP32'ye BaÄŸlan</button>
  <button id="flashBtn" disabled>Firmware'i YÃ¼kle (Erase + Flash)</button>

  <h3>Konsol Ã‡Ä±ktÄ±sÄ±:</h3>
  <pre id="output">Durum: HazÄ±r...\n</pre>

  <!-- esptool-js (en gÃ¼ncel sÃ¼rÃ¼mÃ¼ kullanmak daha iyi) -->
  <script src="https://unpkg.com/esptool-js@0.2.0/dist/web/index.js"></script>

  <script>
    const binFileInput = document.getElementById('binFile');
    const connectBtn   = document.getElementById('connectBtn');
    const flashBtn     = document.getElementById('flashBtn');
    const output       = document.getElementById('output');

    let transport;
    let esploader;
    let binData;

    function log(msg, className = '') {
      const line = document.createElement('div');
      line.textContent = msg;
      if (className) line.className = className;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }

    // Dosya seÃ§ildiÄŸinde
    binFileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file?.name.endsWith('.bin')) {
        log('LÃ¼tfen geÃ§erli bir .bin dosyasÄ± seÃ§in!', 'error');
        return;
      }

      try {
        const buffer = await file.arrayBuffer();
        binData = new Uint8Array(buffer);
        log(`Dosya yÃ¼klendi: \( {file.name} ( \){(binData.length/1024).toFixed(1)} KB)`, 'success');
        flashBtn.disabled = !(transport && esploader && binData);
      } catch (err) {
        log('Dosya okuma hatasÄ±: ' + err.message, 'error');
      }
    });

    // BaÄŸlantÄ±
    connectBtn.addEventListener('click', async () => {
      try {
        const serialPort = await navigator.serial.requestPort();
        await serialPort.open({ baudRate: 115200 });

        transport = new Transport(serialPort);
        esploader = await ESPLoader.init(transport, {
          baudRate: 115200,           // baÅŸlangÄ±Ã§
          flashMode: 'dio',
          flashFreq: '80m',           // â† istediÄŸin deÄŸer (override)
          flashSize: '4MB',
        }, console);  // debug iÃ§in console

        log('BaÄŸlantÄ± baÅŸarÄ±lÄ±! Chip: ' + esploader.chipName, 'success');
        connectBtn.disabled = true;
        flashBtn.disabled = !binData;
      } catch (err) {
        log('BaÄŸlantÄ± hatasÄ±: ' + err.message, 'error');
      }
    });

    // Flash iÅŸlemi
    flashBtn.addEventListener('click', async () => {
      if (!esploader || !binData) {
        log('Ã–nce baÄŸlantÄ± kurun ve .bin dosyasÄ±nÄ± seÃ§in!', 'error');
        return;
      }

      flashBtn.disabled = true;
      log('Ä°ÅŸlem baÅŸlÄ±yor... LÃ¼tfen bekleyin (5-10 dk sÃ¼rebilir)');

      try {
        // 1. Tam erase
        log('TÃ¼m flash siliniyor (full chip erase)...');
        await esploader.eraseFlash();

        // 2. Factory bin'i offset 0'dan yaz
        log('Factory firmware yazÄ±lÄ±yor (offset 0x0)...');
        await esploader.writeFlash([{
          data: binData,
          address: 0x0
        }]);

        log('YÃ¼kleme TAMAMLANDI! ğŸ‰', 'success');
        log('ESP32\'yi resetleyin (GPIO0 baÄŸlantÄ±sÄ±nÄ± kesin).');
      } catch (err) {
        log('HATA: ' + err.message, 'error');
        console.error(err);
      } finally {
        flashBtn.disabled = false;
      }
    });
  </script>
</body>
</html>