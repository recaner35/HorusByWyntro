<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>ESP32 Flash Tool (Stable Legacy)</title>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: monospace; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 8px; border: 1px solid #333; width: 100%; max-width: 600px; }
        h2 { color: #03dac6; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        button { width: 100%; padding: 15px; margin: 10px 0; background: #333; color: white; border: 1px solid #555; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background: #444; }
        button:disabled { background: #222; color: #555; cursor: not-allowed; }
        button.primary { background: #bb86fc; color: #000; border: none; }
        button.primary:hover { background: #9965f4; }
        button.danger { background: #cf6679; color: #000; border: none; }
        #log { width: 100%; height: 250px; background: #000; color: #0f0; border: 1px solid #333; overflow-y: scroll; padding: 10px; margin-top: 15px; font-size: 12px; white-space: pre-wrap; }
    </style>
    <script src="https://unpkg.com/esptool-js@0.2.0/bundle.js"></script>
</head>
<body>

<div class="box">
    <h2>ESP32 Factory Flasher (v0.2)</h2>

    <button id="btnConnect">1. CÄ°HAZA BAÄLAN</button>
    
    <div id="controls" style="display:none;">
        <p>Dosya SeÃ§ (factory.bin):</p>
        <input type="file" id="fileInput" accept=".bin" style="width:100%; margin-bottom:10px; padding:10px; background:#222; border:1px solid #444;">
        
        <button id="btnErase" class="danger">âš ï¸ Ã–NCE BUNU YAP: Ã‡Ä°PÄ° SÄ°L (ERASE)</button>
        <button id="btnFlash" class="primary" disabled>SONRA YÃœKLE (FLASH)</button>
    </div>

    <div id="log">HazÄ±r. BaÄŸlan'a basÄ±n...</div>
</div>

<script>
    let esploader;
    let transport;

    const logEl = document.getElementById("log");
    const btnConnect = document.getElementById("btnConnect");
    const controls = document.getElementById("controls");
    const btnFlash = document.getElementById("btnFlash");
    const btnErase = document.getElementById("btnErase");
    const fileInput = document.getElementById("fileInput");

    function log(msg) {
        logEl.innerHTML += msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
    }

    // 1. BAÄLANTI
    btnConnect.onclick = async () => {
        if (!navigator.serial) return alert("Sadece Chrome/Edge masaÃ¼stÃ¼nde Ã§alÄ±ÅŸÄ±r.");

        try {
            const device = await navigator.serial.requestPort();
            transport = new esptooljs.Transport(device);
            
            // v0.2.0'da constructor farklÄ±dÄ±r, daha basittir.
            // Baudrate: 115200 (Boot), rom_baud_rate
            esploader = new esptooljs.ESPLoader(transport, 115200, null);

            log("BaÄŸlanÄ±lÄ±yor... (Log akmazsa BOOT tuÅŸuna basÄ±n)");
            
            await esploader.main_fn();
            
            log("âœ… BAÄLANDI!");
            log("Chip: " + await esploader.chip_name());
            
            btnConnect.style.display = 'none';
            controls.style.display = 'block';

        } catch (e) {
            log("âŒ HATA: " + e.message);
            console.error(e);
        }
    };

    // DOSYA SEÃ‡Ä°MÄ°
    fileInput.onchange = () => {
        if (fileInput.files.length > 0) {
            btnFlash.disabled = false;
            log("Dosya seÃ§ildi: " + fileInput.files[0].name);
        }
    };

    // 2. SÄ°LME (ERASE) - MUTLAKA YAPILMALI
    btnErase.onclick = async () => {
        if (!confirm("Emin misiniz? TÃ¼m veriler silinecek.")) return;
        try {
            btnErase.disabled = true;
            log("ğŸ§¹ Siliniyor... (Bu iÅŸlem 10-20sn sÃ¼rebilir, bekleyin)");
            
            // v0.2.0 erase fonksiyonu
            await esploader.erase_flash();
            
            log("âœ… SÄ°LME BAÅARILI! Åimdi yÃ¼kleyebilirsiniz.");
        } catch (e) {
            log("Silme HatasÄ±: " + e.message);
        } finally {
            btnErase.disabled = false;
        }
    };

    // 3. YÃœKLEME (FLASH)
    btnFlash.onclick = async () => {
        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = e.target.result;
            
            try {
                btnFlash.disabled = true;
                log("ğŸ“¦ YÃ¼kleme BaÅŸlÄ±yor...");

                // v0.2.0 write_flash parametreleri biraz daha basittir
                await esploader.write_flash(
                    [{ data: data, address: 0x0000 }], // factory.bin -> 0x0000
                    'keep', // flash_size
                    'keep', // flash_mode
                    'keep', // flash_freq
                    false,  // erase_all (zaten sildik)
                    true,   // compress
                    (fileIndex, written, total) => {
                        const p = Math.round((written / total) * 100);
                        log("YÃ¼kleniyor: %" + p);
                    }
                );

                log("ğŸ‰ BÄ°TTÄ°! Cihaz resetleniyor...");
                
                // Manuel Reset (RTS/DTR Oynama)
                await transport.set_dtr(false);
                await transport.set_rts(true);
                await new Promise(r => setTimeout(r, 100));
                await transport.set_rts(false);
                
                log("CihazÄ±nÄ±z fabrika ayarlarÄ±yla aÃ§Ä±lÄ±yor.");

            } catch (err) {
                log("YÃ¼kleme HatasÄ±: " + err.message);
            } finally {
                btnFlash.disabled = false;
            }
        };
        reader.readAsBinaryString(file); // v0.2.0 BinaryString sever
    };
</script>

</body>
</html>