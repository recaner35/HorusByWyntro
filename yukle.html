<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horus Installer - Legacy Fix</title>
    <style>
        body { background-color: #000; color: #0f0; font-family: monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .box { border: 2px solid #0f0; padding: 20px; max-width: 600px; width: 100%; border-radius: 8px; box-shadow: 0 0 10px #0f0; }
        h2 { text-align: center; margin-top: 0; border-bottom: 1px dashed #0f0; padding-bottom: 10px; }
        
        button { width: 100%; padding: 15px; margin: 10px 0; background: #000; color: #0f0; border: 1px solid #0f0; font-family: monospace; font-size: 16px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0f0; color: #000; }
        button:disabled { border-color: #555; color: #555; cursor: not-allowed; background: #000; }
        
        #log { height: 250px; overflow-y: scroll; border: 1px solid #333; padding: 10px; margin-top: 15px; white-space: pre-wrap; font-size: 12px; }
        
        .status-loading { color: yellow; text-align: center; font-size: 1.2em; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .hidden { display: none; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/esptool-js@0.2.0/bundle.js"></script>
</head>
<body>

<div class="box">
    <h2>HORUS FACTORY YÃœKLEYÄ°CÄ°</h2>
    
    <div id="loader" class="status-loading">SÄ°STEM YÃœKLENÄ°YOR...</div>

    <div id="app" class="hidden">
        <button id="btnConnect">1. CÄ°HAZA BAÄžLAN</button>
        
        <div id="controls" class="hidden">
            <p>Factory.bin DosyasÄ±:</p>
            <input type="file" id="fileInput" accept=".bin" style="border:1px solid #0f0; width:95%; padding:5px; margin-bottom:10px;">
            
            <button id="btnErase" style="border-color: red; color: red;">2. Ã‡Ä°PÄ° SÄ°L (ERASE)</button>
            <button id="btnFlash" disabled>3. YÃœKLE (FLASH)</button>
        </div>
    </div>

    <div id="log">Sistem baÅŸlatÄ±lÄ±yor...</div>
</div>

<script>
    const logEl = document.getElementById("log");
    const loader = document.getElementById("loader");
    const app = document.getElementById("app");
    const controls = document.getElementById("controls");
    const btnConnect = document.getElementById("btnConnect");
    const btnErase = document.getElementById("btnErase");
    const btnFlash = document.getElementById("btnFlash");
    const fileInput = document.getElementById("fileInput");

    function log(msg) {
        logEl.innerHTML += "> " + msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
    }

    // SAYFA YÃœKLENDÄ°ÄžÄ°NDE KONTROL
    window.onload = function() {
        if (typeof esptooljs === 'undefined') {
            log("HATA: KÃ¼tÃ¼phane yÃ¼klenemedi! Adblock veya aÄŸ ayarlarÄ±nÄ± kontrol edin.");
            loader.innerText = "YÃœKLEME BAÅžARISIZ";
            loader.style.color = "red";
        } else {
            log("Sistem HazÄ±r. v0.2.0 yÃ¼klendi.");
            loader.classList.add("hidden");
            app.classList.remove("hidden");
        }
    };

    let esploader;
    let transport;

    // 1. BAÄžLAN
    btnConnect.onclick = async () => {
        if (!navigator.serial) return alert("Chrome kullanÄ±n.");

        try {
            const device = await navigator.serial.requestPort();
            
            // v0.2.0 - getInfo Ã§aÄŸÄ±rmaz, direkt baÄŸlanÄ±r
            transport = new esptooljs.Transport(device);
            
            // Terminal Wrapper
            const term = {
                clean: () => {},
                writeLine: (s) => log(s),
                write: (s) => log(s)
            };

            esploader = new esptooljs.ESPLoader(transport, 115200, term);

            log("BaÄŸlanÄ±lÄ±yor... (Log durursa BOOT tuÅŸuna basÄ±lÄ± tutun)");
            
            await esploader.main_fn();
            await esploader.flash_id();

            log("BAÄžLANDI! Dosya seÃ§me ekranÄ± aÃ§Ä±lÄ±yor...");
            btnConnect.classList.add("hidden");
            controls.classList.remove("hidden");

        } catch (e) {
            log("BAÄžLANTI HATASI: " + e.message);
        }
    };

    // DOSYA SEÃ‡Ä°MÄ°
    fileInput.onchange = () => {
        if (fileInput.files.length > 0) {
            btnFlash.disabled = false;
            log("Dosya seÃ§ildi.");
        }
    };

    // 2. SÄ°LME (ERASE)
    btnErase.onclick = async () => {
        if(!confirm("Emin misiniz? Her ÅŸey silinecek.")) return;
        try {
            btnErase.disabled = true;
            btnFlash.disabled = true;
            log("SÄ°LÄ°NÄ°YOR... LÃ¼tfen bekleyin...");
            
            await esploader.erase_flash();
            
            log("âœ… SÄ°LME TAMAMLANDI!");
        } catch(e) {
            log("Silme HatasÄ±: " + e.message);
        } finally {
            btnErase.disabled = false;
            if(fileInput.files.length > 0) btnFlash.disabled = false;
        }
    };

    // 3. YÃœKLEME (FLASH)
    btnFlash.onclick = async () => {
        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        
        // v0.2.0 Ä°Ã‡Ä°N KRÄ°TÄ°K NOKTA: BinaryString OKUMA
        reader.onload = async (e) => {
            const data = e.target.result;
            
            try {
                btnFlash.disabled = true;
                btnErase.disabled = true;
                log("YÃ¼kleme BaÅŸlÄ±yor...");

                // v0.2.0 Write Flash Parametreleri
                await esploader.write_flash(
                    [{ data: data, address: 0x0000 }], 
                    'keep', 
                    'keep', 
                    'keep', 
                    false, // erase_all (zaten yaptÄ±k)
                    true,  // compress
                    (fileIndex, written, total) => {
                        const p = Math.round((written / total) * 100);
                        if(p % 10 === 0) log("YÃ¼kleniyor: %" + p);
                    }
                );

                log("ðŸŽ‰ Ä°ÅžLEM BÄ°TTÄ°! Cihaz resetleniyor...");
                
                await transport.set_dtr(false);
                await transport.set_rts(true);
                await new Promise(r => setTimeout(r, 100));
                await transport.set_rts(false);
                
                log("CihazÄ±nÄ±z fabrika ayarlarÄ±yla aÃ§Ä±lÄ±yor.");
                alert("BaÅŸarÄ±lÄ±!");

            } catch (err) {
                log("YÃ¼kleme HatasÄ±: " + err.message);
            } finally {
                btnFlash.disabled = false;
                btnErase.disabled = false;
            }
        };

        reader.readAsBinaryString(file);
    };
</script>

</body>
</html>
