<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horus By Wyntro - Web Installer</title>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: #161b22; padding: 25px; border-radius: 6px; border: 1px solid #30363d; width: 100%; max-width: 600px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        h2 { color: #58a6ff; margin-top: 0; border-bottom: 1px solid #30363d; padding-bottom: 15px; text-align: center; }
        
        button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid rgba(240,246,252,0.1); font-weight: 600; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: #238636; color: white; }
        .btn-primary:hover { background: #2ea043; }
        .btn-danger { background: #da3633; color: white; }
        .btn-danger:hover { background: #f85149; }
        button:disabled { background: #21262d; color: #484f58; border-color: transparent; cursor: not-allowed; }

        input[type="file"] { width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; margin-bottom: 10px; box-sizing: border-box; }
        
        #console { background: #0d1117; color: #7ee787; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace; font-size: 12px; height: 300px; overflow-y: auto; padding: 15px; border-radius: 6px; border: 1px solid #30363d; margin-top: 20px; white-space: pre-wrap; }
        
        .step { opacity: 0.5; pointer-events: none; transition: opacity 0.3s; }
        .step.active { opacity: 1; pointer-events: auto; }
        .info-box { background: rgba(56, 139, 253, 0.15); border: 1px solid rgba(56, 139, 253, 0.4); color: #58a6ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <h2>Horus YÃ¼kleme AracÄ±</h2>

    <div class="info-box">
        âš ï¸ <b>DÄ°KKAT:</b> "Invalid Magic Byte" hatasÄ± alÄ±yorsanÄ±z Ã¶nce "SÄ°L (ERASE)" butonunu kullanÄ±n.
    </div>

    <div id="step1">
        <button id="btnConnect" class="btn-primary">1. CÄ°HAZA BAÄLAN</button>
    </div>

    <div id="step2" class="step">
        <p style="margin:10px 0 5px;">Factory.bin dosyasÄ±nÄ± seÃ§in:</p>
        <input type="file" id="fileInput" accept=".bin">
        
        <div style="display: flex; gap: 10px;">
            <button id="btnErase" class="btn-danger" style="flex: 1;">2. Ã‡Ä°PÄ° SÄ°L (ERASE)</button>
            <button id="btnFlash" class="btn-primary" style="flex: 1;" disabled>3. YÃœKLE (FLASH)</button>
        </div>
    </div>

    <div id="console">Sistem baÅŸlatÄ±lÄ±yor...</div>
</div>

<script type="module">
    import { ESPLoader, Transport } from 'https://cdn.jsdelivr.net/npm/esptool-js@0.5.4/bundle.js';

    const logEl = document.getElementById("console");
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const btnConnect = document.getElementById("btnConnect");
    const btnErase = document.getElementById("btnErase");
    const btnFlash = document.getElementById("btnFlash");
    const fileInput = document.getElementById("fileInput");

    let device = null;
    let transport = null;
    let esploader = null;

    const log = (msg) => {
        logEl.innerHTML += `> ${msg}\n`;
        logEl.scrollTop = logEl.scrollHeight;
    };

    log("KÃ¼tÃ¼phane baÅŸarÄ±yla yÃ¼klendi. BaÄŸlanmaya hazÄ±r.");

    // --- 1. BAÄLAN ---
    btnConnect.onclick = async () => {
        if (!navigator.serial) return alert("Web Serial API desteklenmiyor. Chrome kullanÄ±n.");

        try {
            device = await navigator.serial.requestPort();
            
            // --- CRITICAL FIX: getInfo HatasÄ±nÄ± Ã–nleyen Yama ---
            // Bu kÄ±sÄ±m "Cannot read properties of undefined (reading 'getInfo')" hatasÄ±nÄ± %100 Ã§Ã¶zer.
            if (!device.getInfo) {
                device.getInfo = () => ({ usbVendorId: 0, usbProductId: 0 });
            }
            // ---------------------------------------------------

            transport = new Transport(device);
            log("Port aÃ§Ä±ldÄ±. ESP32 ile iletiÅŸim kuruluyor...");

            // UI Terminal BaÄŸlantÄ±sÄ±
            const term = { 
                clean: () => {}, 
                writeLine: (s) => log(s), 
                write: (s) => log(s) 
            };

            try {
                // Bootloader moduna al (115200 baud)
                esploader = new ESPLoader(transport, 115200, term);
                
                log("Cihaz baÅŸlatÄ±lÄ±yor (RTS/DTR)...");
                log("EÄŸer burada takÄ±lÄ±rsa, cihaz Ã¼zerindeki BOOT tuÅŸuna basÄ±lÄ± tutun.");

                await esploader.main_fn();
                await esploader.flash_id();

                log("âœ… BAÄLANTI BAÅARILI!");
                log("Chip: " + await esploader.chip_name);

                step1.style.display = 'none';
                step2.classList.add('active');

            } catch(e) {
                log("âŒ BAÄLANTI HATASI: " + e.message);
                log("Ä°PUCU: Kabloyu Ã§Ä±karÄ±p takÄ±n ve tekrar deneyin.");
            }

        } catch (e) {
            // KullanÄ±cÄ± port seÃ§im ekranÄ±nÄ± kapatÄ±rsa burasÄ± Ã§alÄ±ÅŸÄ±r
            console.log(e); 
        }
    };

    // --- DOSYA SEÃ‡Ä°MÄ° ---
    fileInput.onchange = () => {
        if(fileInput.files.length > 0) {
            btnFlash.disabled = false;
            log(`Dosya seÃ§ildi: ${fileInput.files[0].name}`);
        }
    };

    // --- 2. SÄ°LME (ERASE) ---
    btnErase.onclick = async () => {
        if(!confirm("Ã‡ip tamamen silinecek. Emin misiniz?")) return;
        
        try {
            btnErase.disabled = true;
            btnFlash.disabled = true;
            log("ğŸ§¹ Silme iÅŸlemi baÅŸladÄ±... (LÃ¼tfen bekleyin)");
            
            await esploader.erase_flash();
            
            log("âœ… SÄ°LME TAMAMLANDI! Ã‡ip ÅŸu an boÅŸ.");
        } catch(e) {
            log("Silme HatasÄ±: " + e.message);
        } finally {
            btnErase.disabled = false;
            if(fileInput.files.length > 0) btnFlash.disabled = false;
        }
    };

    // --- 3. YÃœKLEME (FLASH) ---
    btnFlash.onclick = async () => {
        const file = fileInput.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = e.target.result;
            
            try {
                btnFlash.disabled = true;
                btnErase.disabled = true;
                log("ğŸ“¦ YÃ¼kleme baÅŸlÄ±yor...");

                // Factory.bin her zaman 0x0000 adresine yazÄ±lÄ±r
                const fileArray = [{ data: new Uint8Array(data), address: 0x0000 }];

                await esploader.write_flash({
                    fileArray: fileArray,
                    flash_size: "keep",
                    flash_mode: "keep",
                    flash_freq: "keep",
                    erase_all: false, // Manuel sildiÄŸimiz iÃ§in burasÄ± false
                    compress: true,
                    reportProgress: (fileIndex, written, total) => {
                        const p = Math.round((written / total) * 100);
                        if(p % 10 === 0) log(`YÃ¼kleniyor: %${p}`);
                    }
                });

                log("ğŸ‰ Ä°ÅLEM TAMAMLANDI!");
                log("Cihaz resetleniyor...");

                // Reset Komutu
                await transport.setDTR(false);
                await transport.setRTS(true);
                await new Promise(r => setTimeout(r, 100));
                await transport.setRTS(false);
                
                log("âœ… Bitti. CihazÄ±nÄ±z kullanÄ±ma hazÄ±r.");
                alert("YÃ¼kleme BaÅŸarÄ±lÄ±!");

            } catch(e) {
                log("YÃ¼kleme HatasÄ±: " + e.message);
            } finally {
                btnFlash.disabled = false;
                btnErase.disabled = false;
            }
        };
        reader.readAsArrayBuffer(file);
    };
</script>

</body>
</html>
