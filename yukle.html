<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>ESP32 Flash Tool - Legacy Mode</title>
    <style>
        body { font-family: monospace; background: #222; color: #ddd; padding: 20px; text-align: center; }
        .box { background: #333; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #555; border-radius: 8px; }
        button { width: 100%; padding: 15px; margin: 10px 0; font-size: 16px; font-weight: bold; cursor: pointer; border: none; }
        .btn-con { background: #007bff; color: white; }
        .btn-erase { background: #dc3545; color: white; }
        .btn-flash { background: #28a745; color: white; }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        #status { color: yellow; margin: 10px 0; }
        #log { background: black; color: lime; height: 200px; overflow-y: scroll; text-align: left; padding: 10px; border: 1px solid #777; white-space: pre-wrap; margin-top: 10px; }
        .hidden { display: none; }
    </style>
    
    <script src="https://unpkg.com/esptool-js@0.2.0/bundle.js"></script>
</head>
<body>

<div class="box">
    <h2>ESP32 KESÄ°N Ã‡Ã–ZÃœM</h2>
    <div id="loading">KÃ¼tÃ¼phane yÃ¼kleniyor... LÃ¼tfen bekleyin...</div>
    
    <div id="mainApp" class="hidden">
        <button id="btnConnect" class="btn-con">1. CÄ°HAZA BAÄžLAN</button>
        
        <div id="step2" class="hidden">
            <p>Dosya SeÃ§in (factory.bin):</p>
            <input type="file" id="fileInput" accept=".bin" style="width:90%; padding:10px; background:#444; color:white; margin-bottom:10px;">
            
            <button id="btnErase" class="btn-erase">2. Ã‡Ä°PÄ° SÄ°L (Ã–NCE BUNU YAP)</button>
            <button id="btnFlash" class="btn-flash" disabled>3. YÃœKLE (SONRA BUNU)</button>
        </div>
    </div>

    <div id="log">Sistem hazÄ±r bekleniyor...</div>
</div>

<script>
    // GLOBAL DEÄžÄ°ÅžKENLER
    let espLoaderTerminal = {
        clean: function() { this.write(""); },
        writeLine: function(str) { this.write(str); },
        write: function(str) { 
            const log = document.getElementById('log');
            log.innerHTML += str + "\n";
            log.scrollTop = log.scrollHeight;
        }
    };
    
    let esploader;
    let transport;

    // SAYFA YÃœKLENDÄ°ÄžÄ°NDE Ã‡ALIÅžIR (Timing hatasÄ±nÄ± Ã¶nler)
    window.onload = function() {
        // KÃ¼tÃ¼phanenin yÃ¼klendiÄŸini kontrol et
        if (typeof esptooljs === 'undefined') {
            document.getElementById('loading').innerHTML = "HATA: Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin, kÃ¼tÃ¼phane yÃ¼klenemedi.";
            return;
        }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        
        // BAÄžLAN BUTONU
        document.getElementById('btnConnect').onclick = async function() {
            if (!navigator.serial) return alert("Chrome kullanÄ±n!");
            
            try {
                const device = await navigator.serial.requestPort();
                
                // v0.2.0 YAPISI - TRANSPORT
                transport = new esptooljs.Transport(device);
                
                // LOADER BAÅžLAT (getInfo kontrolÃ¼ yapmadan)
                esploader = new esptooljs.ESPLoader(transport, 115200, espLoaderTerminal);
                
                espLoaderTerminal.write("BaÄŸlanÄ±lÄ±yor... (Log akmazsa BOOT tuÅŸuna basÄ±n)");
                
                await esploader.main_fn();
                await esploader.flash_id(); // Ã‡ip ID'sini al
                
                espLoaderTerminal.write("âœ… BAÄžLANTI TAMAM!");
                
                // UI AÃ‡
                document.getElementById('btnConnect').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');

            } catch(e) {
                espLoaderTerminal.write("âŒ HATA: " + e.message);
            }
        };

        // DOSYA SEÃ‡Ä°MÄ°
        document.getElementById('fileInput').onchange = function() {
            if(this.files.length > 0) {
                document.getElementById('btnFlash').disabled = false;
            }
        };

        // SÄ°LME Ä°ÅžLEMÄ° (ERASE)
        document.getElementById('btnErase').onclick = async function() {
            if(!confirm("TÃ¼m veri silinecek?")) return;
            try {
                document.getElementById('btnErase').disabled = true;
                espLoaderTerminal.write("ðŸ§¹ Siliniyor... Bekleyin...");
                
                await esploader.erase_flash();
                
                espLoaderTerminal.write("âœ… SÄ°LÄ°NDÄ°! Åžimdi yÃ¼kleyebilirsiniz.");
            } catch(e) {
                espLoaderTerminal.write("Silme HatasÄ±: " + e.message);
            } finally {
                document.getElementById('btnErase').disabled = false;
            }
        };

        // YÃœKLEME Ä°ÅžLEMÄ° (FLASH)
        document.getElementById('btnFlash').onclick = async function() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = e.target.result; // Binary String olarak gelir
                
                try {
                    document.getElementById('btnFlash').disabled = true;
                    espLoaderTerminal.write("ðŸ“¦ YÃ¼kleme BaÅŸlÄ±yor...");

                    // v0.2.0 write_flash parametreleri
                    // Dosya iÃ§eriÄŸi (binary string), adres, vs.
                    await esploader.write_flash(
                        [{ data: data, address: 0x0000 }], 
                        'keep', 
                        'keep', 
                        'keep', 
                        false, // erase all (kapalÄ±, zaten sildik)
                        true,  // compress
                        function(fileIndex, written, total) {
                            const p = Math.round((written/total)*100);
                            if(p % 10 === 0) espLoaderTerminal.write("YÃ¼kleniyor: %" + p);
                        }
                    );
                    
                    espLoaderTerminal.write("ðŸŽ‰ Ä°ÅžLEM BÄ°TTÄ°! CihazÄ± resetleyin.");
                    
                    // Reset
                    await transport.set_dtr(false);
                    await transport.set_rts(true);
                    await new Promise(r => setTimeout(r, 100));
                    await transport.set_rts(false);

                } catch(e) {
                    espLoaderTerminal.write("YÃ¼kleme HatasÄ±: " + e.message);
                    document.getElementById('btnFlash').disabled = false;
                }
            };
            
            // v0.2.0 Binary String ile Ã§alÄ±ÅŸÄ±r
            reader.readAsBinaryString(file);
        };
    };
</script>

</body>
</html>
