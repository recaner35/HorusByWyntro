<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Fix Tool (Erase & Flash)</title>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #e63946; }
        .controls { background: #333; padding: 20px; border-radius: 8px; width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; }
        button { padding: 12px; cursor: pointer; font-weight: bold; font-size: 16px; border: none; border-radius: 4px; transition: 0.2s; }
        .btn-connect { background: #007bff; color: white; }
        .btn-flash { background: #28a745; color: white; }
        .btn-disabled { background: #555; color: #aaa; cursor: not-allowed; }
        #terminal { background: #000; color: #0f0; width: 100%; max-width: 800px; height: 350px; overflow-y: auto; padding: 10px; margin-top: 20px; border: 1px solid #444; font-size: 14px; white-space: pre-wrap; }
        .checkbox-container { display: flex; align-items: center; gap: 10px; background: #444; padding: 10px; border-radius: 4px; border: 1px solid #e63946; }
        input[type="checkbox"] { width: 20px; height: 20px; accent-color: #e63946; }
    </style>
    <script src="https://unpkg.com/esptool-js@0.5.4/bundle.js"></script>
</head>
<body>

    <h1>ESP32 Kurtarma ve Yükleme</h1>

    <div class="controls">
        <label>1. Cihaza Bağlan:</label>
        <button id="connectBtn" class="btn-connect">BAĞLAN (Connect)</button>

        <label>2. Dosya Seç (factory.bin):</label>
        <input type="file" id="fileInput" accept=".bin" disabled>

        <div class="checkbox-container">
            <input type="checkbox" id="eraseCheck" checked>
            <label for="eraseCheck" style="color: #ff9999; font-weight: bold;">⚠️ Yüklemeden önce Çipi TAMAMEN SİL (Erase Flash)</label>
        </div>
        <small style="color: #ccc;">"Invalid magic byte" veya "OTA partition" hatası alıyorsanız bunu mutlaka seçin.</small>

        <label>3. İşlemi Başlat:</label>
        <button id="flashBtn" class="btn-flash btn-disabled" disabled>YÜKLE (Flash)</button>
    </div>

    <div id="terminal">Loglar burada görünecek...</div>

    <script>
        let port;
        let transport;
        let esploader;
        
        const term = document.getElementById("terminal");
        const connectBtn = document.getElementById("connectBtn");
        const flashBtn = document.getElementById("flashBtn");
        const fileInput = document.getElementById("fileInput");
        const eraseCheck = document.getElementById("eraseCheck");

        function log(msg) {
            term.innerHTML += msg + "\n";
            term.scrollTop = term.scrollHeight;
        }

        connectBtn.onclick = async () => {
            if (!navigator.serial) return alert("Chrome kullanın.");

            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });

                log("Seri port açıldı. Bağlanılıyor...");

                const Transport = window.esptooljs.Transport;
                const ESPLoader = window.esptooljs.ESPLoader;

                transport = new Transport(port);
                
                const terminalWrapper = {
                    clean: () => {}, 
                    writeLine: (data) => log(data),
                    write: (data) => log(data) 
                };

                esploader = new ESPLoader(transport, 115200, terminalWrapper);
                await esploader.main_fn(); 
                
                connectBtn.textContent = "BAĞLANDI";
                connectBtn.classList.add("btn-disabled");
                connectBtn.disabled = true;
                fileInput.disabled = false;
                
                log("\n✅ Cihaz Hazır. Dosyayı seçin ve silme seçeneğinin işaretli olduğundan emin olun.");

            } catch (e) {
                log("HATA: " + e.message);
                if(port) await port.close(); 
            }
        };

        fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
                flashBtn.disabled = false;
                flashBtn.classList.remove("btn-disabled");
                log(`Dosya hazır: ${fileInput.files[0].name}`);
            }
        };

        flashBtn.onclick = async () => {
            const file = fileInput.files[0];
            if (!file) return;

            const shouldErase = eraseCheck.checked;
            const reader = new FileReader();

            reader.onload = async (e) => {
                const data = e.target.result;
                
                try {
                    flashBtn.disabled = true;
                    log("\n--- İŞLEM BAŞLIYOR ---");

                    if (shouldErase) {
                        log("⚠️ DİKKAT: Çip tamamen siliniyor (Bu işlem 10-30 saniye sürebilir)...");
                        // Silme komutu
                        await esploader.erase_flash();
                        log("✅ Silme işlemi tamamlandı. Tertemiz bir sayfa açıldı.");
                    }

                    log("Dosya yazılıyor...");
                    const fileArray = [{ data: new Uint8Array(data), address: 0x0000 }];
                    
                    await esploader.write_flash({
                        fileArray: fileArray,
                        flash_size: "keep",
                        flash_mode: "keep",
                        flash_freq: "keep",
                        erase_all: false, // Yukarıda manuel sildiğimiz için burada false
                        compress: true,
                        reportProgress: (fileIndex, written, total) => {
                            const percent = Math.round((written / total) * 100);
                            if (percent % 10 === 0) log(`Yükleniyor... %${percent}`);
                        },
                    });

                    log("\n✅ Yükleme Başarılı! Cihaz resetleniyor...");
                    
                    await transport.setDTR(false);
                    await transport.setRTS(true);
                    await new Promise(r => setTimeout(r, 100));
                    await transport.setRTS(false);
                    
                    log("BİTTİ. Cihazınız artık 'factory' modundan açılmalı.");
                    
                } catch (e) {
                    log("Yükleme Hatası: " + e.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        };
    </script>
</body>
</html>
