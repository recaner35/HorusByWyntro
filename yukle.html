<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>Horus Kesin Yükleyici</title>
    <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f4f4f9; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 400px; text-align: center; }
        .file-group { text-align: left; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 10px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 13px; }
        #status { margin-top: 15px; font-size: 14px; font-weight: bold; }
        esp-web-install-button { margin-top: 20px; --esp-tools-button-color: #007bff; }
    </style>
</head>
<body>

<div class="card">
    <h2>Horus Flasher (v1.0)</h2>
    
    <div class="file-group">
        <label>1. Firmware (.bin)</label>
        <input type="file" id="fw" accept=".bin">
    </div>

    <div class="file-group">
        <label>2. LittleFS (.bin)</label>
        <input type="file" id="fs" accept=".bin">
    </div>

    <esp-web-install-button id="installBtn"></esp-web-install-button>
    
    <div id="status">Lütfen dosyaları seçin</div>
</div>

<script>
    const btn = document.getElementById("installBtn");
    const fwInput = document.getElementById("fw");
    const fsInput = document.getElementById("fs");
    const status = document.getElementById("status");

    // Dosyalar seçildiğinde butonu hazırlayan fonksiyon
    const prepareUpdate = () => {
        if (fwInput.files.length > 0 && fsInput.files.length > 0) {
            
            // Bileşene manifest dosyasını string olarak değil, 
            // doğrudan bellek adresi olarak enjekte ediyoruz.
            const manifest = {
                "name": "Horus Firmware",
                "builds": [
                    {
                        "chipFamily": "ESP32",
                        "parts": [
                            { "path": URL.createObjectURL(fwInput.files[0]), "offset": 65536 }, // 0x10000
                            { "path": URL.createObjectURL(fsInput.files[0]), "offset": 2686976 } // 0x290000
                        ]
                    }
                ]
            };

            // Modern tarayıcılar için "manifest" özelliğine veri objesini atıyoruz
            // JSON.stringify kullanarak bileşenin indirme yapmasını engelliyoruz
            btn.manifest = manifest;
            
            status.innerText = "Bağlanmaya Hazır!";
            status.style.color = "green";
        }
    };

    fwInput.addEventListener("change", prepareUpdate);
    fsInput.addEventListener("change", prepareUpdate);

    // Karta bağlanmadan önce son bir kontrol
    btn.addEventListener("click", (e) => {
        if (!fwInput.files[0] || !fsInput.files[0]) {
            e.preventDefault();
            alert("Lütfen önce iki dosyayı da seçin!");
        }
    });
</script>

</body>
</html>
