
name: Build Horus Firmware

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MKLITTLEFS_VERSION: 3.2.0

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Cache Arduino Core & Libraries
      uses: actions/cache@v4
      with:
        path: |
          ~/.arduino15
          ~/Arduino/libraries
        key: arduino-${{ runner.os }}-esp32

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: pip-${{ runner.os }}

    - name: Auto Bump Version
      id: bump_version
      run: |
        cat <<EOF > bump_version.py
        import json
        import re
        import os

        try:
            with open('version.json', 'r') as f:
                data = json.load(f)
            
            old_version = data.get('version', '0.0.0')
            parts = [int(x) for x in old_version.split('.')]
            parts[-1] += 1
            new_version = ".".join(map(str, parts))
            
            data['version'] = new_version
            data['url'] = f"https://github.com/recaner35/HorusByWyntro/releases/download/{new_version}/HorusByWyntro.ino.bin"
            
            with open('version.json', 'w') as f:
                json.dump(data, f, indent=2)
            
            print(f"Previous Version: {old_version}")
            print(f"New Version: {new_version}")

            import glob
            ino_files = glob.glob('**/*.ino', recursive=True)
            if not ino_files:
                print("Error: No .ino file found for version bumping!")
            else:
                ino_path = ino_files[0]
                print(f"Updating version in: {ino_path}")
                
                with open(ino_path, 'r') as f:
                    content = f.read()
                
                content = re.sub(r'#define FIRMWARE_VERSION ".*?"', f'#define FIRMWARE_VERSION "{new_version}"', content)
                
                with open(ino_path, 'w') as f:
                    f.write(content)
            
            with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                env_file.write(f"NEW_VERSION={new_version}\n")
        
        except Exception as e:
            print(f"Error: {e}")
            exit(1)
        EOF
        
        python bump_version.py

    - name: Update SW Version
      run: |
        sed -i "s/const CACHE_NAME = '.*'/const CACHE_NAME = 'horus-v${{ env.NEW_VERSION }}'/" data/sw.js
        echo "Service Worker version updated to ${{ env.NEW_VERSION }}"

    - name: Commit and Push Version Bump
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add version.json
        find . -name "*.ino" -exec git add {} \;
        git commit -m "chore: bump version to ${{ env.NEW_VERSION }} [skip ci]" || echo "No changes"
        git push

    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v2

    - name: Install ESP32 Platform
      run: |
        arduino-cli config init --overwrite
        arduino-cli core update-index --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        arduino-cli core install esp32:esp32 --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

    - name: Install Libraries
      run: |
        arduino-cli lib install "AccelStepper"
        arduino-cli lib install "ArduinoJson"
        arduino-cli lib install "WiFiManager"
        
        if [ ! -d "$HOME/Arduino/libraries/AsyncTCP" ]; then
          echo "AsyncTCP indiriliyor..."
          git clone https://github.com/me-no-dev/AsyncTCP.git ~/Arduino/libraries/AsyncTCP
        else
          echo "AsyncTCP zaten yÃ¼klÃ¼ (Cached)."
        fi

        if [ ! -d "$HOME/Arduino/libraries/ESPAsyncWebServer" ]; then
          echo "ESPAsyncWebServer indiriliyor..."
          git clone https://github.com/me-no-dev/ESPAsyncWebServer.git ~/Arduino/libraries/ESPAsyncWebServer
        else
          echo "ESPAsyncWebServer zaten yÃ¼klÃ¼ (Cached)."
        fi

    - name: Prepare custom partitions
      run: |
        mkdir -p build
        # CSV dosyasÄ±nÄ± partitions.csv olarak ana dizine (ino yanÄ±na) kopyalÄ±yoruz
        cp partitions/partitions_horus_ota.csv partitions.csv

    - name: Compile Sketch
      run: |
        arduino-cli compile \
          --fqbn esp32:esp32:esp32 \
          --build-path build \
          --build-property build.custom_partitions=partitions.csv \
          HorusByWyntro.ino

    - name: Compress Web Assets (Gzip)
      run: |
        echo "Web dosyalari 190KB limitine sigmasi icin sikistiriliyor..."
        DATA_PATH=$(find . -type d -name "data" | head -n 1)
        
        if [ -d "$DATA_PATH" ]; then
          find "$DATA_PATH" -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" \) -exec gzip -9 -v -f -n {} \;
          
          echo "SÄ±kÄ±ÅŸtÄ±rma tamamlandÄ±. Yeni dosya listesi ve boyutlarÄ±:"
          ls -lhR "$DATA_PATH"
        else
          echo "HATA: Data klasÃ¶rÃ¼ bulunamadÄ±!"
          exit 1
        fi

    - name: Build LittleFS Image
      run: |
        echo "Yerel mklittlefs araci araniyor..."
        MKLITTLEFS_BIN=$(find /home/runner/.arduino15 -name mklittlefs -type f | head -n 1)
        
        if [ -z "$MKLITTLEFS_BIN" ]; then
            echo "HATA: mklittlefs yerel dosyalarda bulunamadi!"
            exit 1
        fi
        
        chmod +x "$MKLITTLEFS_BIN"
        DATA_PATH=$(find . -type d -name "data" | head -n 1)
        
        echo "Building LittleFS from $DATA_PATH"
        
        # BOYUT: 0x130000 = 1245184 (NO-FACTORY LAYOUT)
        "$MKLITTLEFS_BIN" -c "$DATA_PATH" -p 256 -b 4096 -s 1245184 ./build/HorusByWyntro.littlefs.bin

    - name: Generate Factory Bin
      run: |
        pip install esptool

        FIRMWARE_BIN=$(find ./build -name "*.ino.bin" | head -n 1)
        PARTITIONS_BIN=$(find ./build -name "*.partitions.bin" | head -n 1)
        BOOTLOADER_BIN=$(find ./build -name "*.bootloader.bin" | head -n 1)
        SPIFFS_BIN="./build/HorusByWyntro.littlefs.bin"
        BOOT_APP0_BIN=$(find ~/.arduino15 -name "boot_app0.bin" | head -n 1)

        echo "Firmware: $FIRMWARE_BIN"
        echo "Partitions: $PARTITIONS_BIN"
        echo "Bootloader: $BOOTLOADER_BIN"

        # OFFSET GUNCELLENDI: 0x2F0000 (NO-FACTORY LAYOUT)
        esptool.py --chip esp32 merge_bin \
          -o ./build/HorusByWyntro-factory.bin \
          --flash_mode dio \
          --flash_freq 80m \
          --flash_size 4MB \
          0x1000 "$BOOTLOADER_BIN" \
          0x8000 "$PARTITIONS_BIN" \
          0xe000 "$BOOT_APP0_BIN" \
          0x10000 "$FIRMWARE_BIN" \
          0x2D0000 "$SPIFFS_BIN"

        echo "Factory bin hazÄ±r"

    - name: Copy factory.bin to website folder for web installer
      run: |
        mkdir -p website/factory
        cp ./build/HorusByWyntro-factory.bin website/HorusByWyntro-factory.bin || echo "Copy failed - website root"
        cp ./build/HorusByWyntro-factory.bin website/factory/HorusByWyntro-factory.bin || echo "Copy failed - factory folder"
        ls -la website/        # Debug: Ana klasÃ¶r kontrol
        ls -la website/factory/ # Debug: Factory klasÃ¶rÃ¼ kontrol
    
    - name: Copy separate files for partitioned web installer
      run: |
          mkdir -p website
          cp ./build/*.bootloader.bin website/bootloader.bin || echo "Bootloader copy failed"
          cp ./build/*.partitions.bin website/partitions.bin || echo "Partitions copy failed"
          # boot_app0.bin genellikle Arduino paketinden gelir
          BOOT_APP0=$(find ~/.arduino15/packages/esp32/hardware/esp32/*/tools/partitions -name "boot_app0.bin" | head -n 1)
          cp "$BOOT_APP0" website/boot_app0.bin || echo "boot_app0 copy failed"
          cp ./build/*.ino.bin website/firmware.bin || echo "Firmware copy failed"
          cp ./build/HorusByWyntro.littlefs.bin website/littlefs.bin || echo "LittleFS copy failed"
          # Hala merged bin'i de kopyala (yedek iÃ§in)
          cp ./build/HorusByWyntro-factory.bin website/HorusByWyntro-factory.bin
          ls -la website/  # Debug: kopyalanan dosyalarÄ± logla

    - name: Commit website changes to main branch (for Pages update)
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"

        git add website/HorusByWyntro-factory.bin
        git add website/factory/HorusByWyntro-factory.bin
        git add website/bootloader.bin
        git add website/partitions.bin
        git add website/boot_app0.bin
        git add website/firmware.bin
        git add website/littlefs.bin

        git commit -m "chore: update latest factory.bin for web flasher [skip ci]" || echo "No changes"

        git stash

        git pull --rebase origin main

        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.NEW_VERSION }}
        name: Release ${{ env.NEW_VERSION }}
        generate_release_notes: true
        make_latest: true
        body: |
          ## ðŸš€ Horus v${{ env.NEW_VERSION }} YayÄ±nda!
          **Not:** Bu sÃ¼rÃ¼m sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ dosya sistemi (GZIP) ve Minimal SPIFFS kullanÄ±r.
        files: |
          ./build/HorusByWyntro.ino.bin
          ./build/HorusByWyntro.littlefs.bin
          ./build/HorusByWyntro-factory.bin
        
    - name: Prepare Pages
      run: |
        mkdir -p public
        cp version.json public/
        cp ./build/*.bin public/
        
        if [ -d "website" ]; then
            echo "Copying website content..."
            cp -r website/* public/
        else
            echo "Error: 'website' directory not found!"
            exit 1
        fi

    - name: Generate dynamic manifest.json
      run: |
          cat <<EOF > website/manifest.json
          {
            "name": "Horus Factory Firmware",
            "version": "${{ env.NEW_VERSION }}",
            "new_install_prompt_erase": true,
            "chipFamily": "ESP32",
            "flashSize": "4MB",
            "flashMode": "dio",
            "flashFreq": "80m",
            "builds": [
              {
                "chipFamily": "ESP32",
                "parts": [
                  {
                    "parts": [
                      { "path": "bootloader.bin", "offset": 4096 },
                      { "path": "partitions.bin", "offset": 32768 },
                      { "path": "boot_app0.bin", "offset": 57344 },
                      { "path": "firmware.bin", "offset": 65536 },
                      { "path": "littlefs.bin", "offset": 2949120 }
                    ]
                  }
                ]
             }
            ]
          }
          EOF

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages
