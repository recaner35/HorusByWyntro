name: Build Horus Firmware

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MKLITTLEFS_VERSION: 3.2.0

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Auto Bump Version
      id: bump_version
      run: |
        cat <<EOF > bump_version.py
        import json
        import re
        import os

        try:
            with open('version.json', 'r') as f:
                data = json.load(f)
            
            old_version = data.get('version', '0.0.0')
            parts = [int(x) for x in old_version.split('.')]
            parts[-1] += 1
            new_version = ".".join(map(str, parts))
            
            data['version'] = new_version
            data['url'] = f"https://github.com/recaner35/HorusByWyntro/releases/download/{new_version}/HorusByWyntro.ino.bin"
            
            with open('version.json', 'w') as f:
                json.dump(data, f, indent=2)
            
            print(f"Previous Version: {old_version}")
            print(f"New Version: {new_version}")

            import glob
            ino_files = glob.glob('**/*.ino', recursive=True)
            if not ino_files:
                print("Error: No .ino file found for version bumping!")
            else:
                ino_path = ino_files[0]
                print(f"Updating version in: {ino_path}")
                
                with open(ino_path, 'r') as f:
                    content = f.read()
                
                content = re.sub(r'#define FIRMWARE_VERSION ".*?"', f'#define FIRMWARE_VERSION "{new_version}"', content)
                
                with open(ino_path, 'w') as f:
                    f.write(content)
            
            with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                env_file.write(f"NEW_VERSION={new_version}\n")
        
        except Exception as e:
            print(f"Error: {e}")
            exit(1)
        EOF
        
        python bump_version.py

    - name: Commit and Push Version Bump
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add version.json
        find . -name "*.ino" -exec git add {} \;
        git commit -m "chore: bump version to ${{ env.NEW_VERSION }} [skip ci]"
        git push

    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v2

    - name: Install ESP32 Platform
      run: |
        arduino-cli config init
        arduino-cli core update-index --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        arduino-cli core install esp32:esp32 --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

    - name: Install Libraries
      run: |
        arduino-cli lib install "AccelStepper"
        arduino-cli lib install "ArduinoJson"
        arduino-cli lib install "WiFiManager"
        git clone https://github.com/me-no-dev/AsyncTCP.git ~/Arduino/libraries/AsyncTCP
        git clone https://github.com/me-no-dev/ESPAsyncWebServer.git ~/Arduino/libraries/ESPAsyncWebServer

    - name: Compile Sketch
      run: |
        mkdir -p build
        SKETCH_PATH=$(find . -name "*.ino" | head -n 1)
        arduino-cli compile --fqbn esp32:esp32:esp32 --output-dir ./build "$SKETCH_PATH"

    - name: Build LittleFS Image
      run: |
        # --- KRİTİK DÜZELTME BAŞLANGICI ---
        # mklittlefs'i internetten indirmek yerine, Arduino CLI'nin 
        # zaten indirdiği yerel dosyayı bulup kullanıyoruz.
        
        echo "Yerel mklittlefs araci araniyor..."
        # Arduino paketleri genelde ~/.arduino15 altinda olur.
        MKLITTLEFS_BIN=$(find /home/runner/.arduino15 -name mklittlefs -type f | head -n 1)
        
        if [ -z "$MKLITTLEFS_BIN" ]; then
           echo "HATA: mklittlefs yerel dosyalarda bulunamadi!"
           exit 1
        fi
        
        echo "BULUNDU: $MKLITTLEFS_BIN"
        
        # Dosyayı çalıştırılabilir yap
        chmod +x "$MKLITTLEFS_BIN"

        # Data klasörünü kontrol et
        DATA_PATH=$(find . -type d -name "data" | head -n 1)
        if [ -z "$DATA_PATH" ]; then
           echo "No data directory found, creating empty one for valid bin generation"
           mkdir -p data
           DATA_PATH="data"
        fi
        
        echo "Building LittleFS from $DATA_PATH"
        
        # Bulduğumuz aracı kullanarak imajı oluşturuyoruz
        "$MKLITTLEFS_BIN" -c "$DATA_PATH" -p 256 -b 4096 -s 1441792 ./build/HorusByWyntro.littlefs.bin
        # --- KRİTİK DÜZELTME SONU ---

    - name: Get Partition Offset
      id: get_offset
      run: |
        python -c "
        import csv
        import os
        
        # Varsayılan değer (Default Partition Scheme için)
        found_offset = '0x290000'
        csv_file = 'partitions.csv'
        
        if os.path.exists(csv_file):
            print(f'{csv_file} bulundu, analiz ediliyor...')
            try:
                with open(csv_file, 'r') as f:
                    # Yorum satırlarını temizle
                    lines = [line for line in f if line.strip() and not line.strip().startswith('#')]
                    reader = csv.reader(lines)
                    
                    for row in reader:
                        # Boşlukları temizle
                        row = [x.strip() for x in row]
                        if len(row) < 5: continue
                        
                        name = row[0]
                        ptype = row[1]
                        subtype = row[2]
                        offset = row[3]
                        
                        # Data partition (spiffs veya littlefs) arıyoruz
                        # Type: data, SubType: spiffs(0x82) veya littlefs(0x83)
                        if (ptype == 'data' or ptype == '0x01') and (subtype in ['spiffs', 'littlefs', '0x82', '0x83'] or name in ['spiffs', 'littlefs']):
                            if offset and offset != '':
                                found_offset = offset
                                print(f'OFFSET BULUNDU: {found_offset} ({name})')
                                break
            except Exception as e:
                print(f'CSV okuma hatası: {e}')
        else:
            print(f'UYARI: {csv_file} bulunamadı, varsayılan {found_offset} kullanılacak.')
        
        # GitHub Output değişkenine yaz
        with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
            fh.write(f'LITTLEFS_OFFSET={found_offset}\n')
        "

    # Adım 2: Factory Bin Oluştur
    - name: Generate Factory Bin
      run: |
        pip install esptool

        FIRMWARE_BIN=$(find ./build -name "*.ino.bin" | head -n 1)
        PARTITIONS_BIN=$(find ./build -name "*.partitions.bin" | head -n 1)
        BOOTLOADER_BIN=$(find ./build -name "*.bootloader.bin" | head -n 1)
        LITTLEFS_BIN="./build/HorusByWyntro.littlefs.bin"
        BOOT_APP0_BIN=$(find ~/.arduino15 -name "boot_app0.bin" | head -n 1)
        
        # Python adımından gelen offset değerini alıyoruz
        LITTLEFS_OFFSET=${{ steps.get_offset.outputs.LITTLEFS_OFFSET }}

        echo "Firmware: $FIRMWARE_BIN"
        echo "Partitions: $PARTITIONS_BIN"
        echo "Bootloader: $BOOTLOADER_BIN"
        echo "LittleFS Offset: $LITTLEFS_OFFSET"

        esptool.py --chip esp32 merge_bin \
          -o ./build/HorusByWyntro-factory.bin \
          --flash_mode dio \
          --flash_freq 40m \
          --flash_size 4MB \
          0x1000 "$BOOTLOADER_BIN" \
          0x8000 "$PARTITIONS_BIN" \
          0xe000 "$BOOT_APP0_BIN" \
          0x10000 "$FIRMWARE_BIN" \
          $LITTLEFS_OFFSET "$LITTLEFS_BIN"

        echo "Fabrika dosyası oluşturuldu (Offset: $LITTLEFS_OFFSET): ./build/HorusByWyntro-factory.bin"
    - name: Prepare Pages
      run: |
        mkdir -p public
        cp version.json public/
        cp ./build/*.bin public/
        
        if [ -d "website" ]; then
           echo "Copying website content..."
           cp -r website/* public/
        else
           echo "Error: 'website' directory not found!"
           exit 1
        fi

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages
