name: Build Horus Firmware

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MKLITTLEFS_VERSION: 3.2.0


    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Tüm geçmişi çek (versiyonlama için iyi olabilir)

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Auto Bump Version
      id: bump_version
      run: |
        # Python script to increment version
        cat <<EOF > bump_version.py
        import json
        import re
        import os

        # 1. Read and Bump version.json
        try:
            with open('version.json', 'r') as f:
                data = json.load(f)
            
            old_version = data.get('version', '0.0.0')
            parts = [int(x) for x in old_version.split('.')]
            parts[-1] += 1 # Patch arttır
            new_version = ".".join(map(str, parts))
            
            # Update URL to point to the new Release asset
            # NOTE: User can change this to Pages URL if preferred, but Releases is standard for history.
            data['version'] = new_version
            data['url'] = f"https://github.com/recaner35/HorusByWyntro/releases/download/{new_version}/HorusByWyntro.ino.bin"
            
            with open('version.json', 'w') as f:
                json.dump(data, f, indent=2)
            
            print(f"Previous Version: {old_version}")
            print(f"New Version: {new_version}")

            # 2. Update .ino file
            import glob
            ino_files = glob.glob('**/*.ino', recursive=True)
            if not ino_files:
                print("Error: No .ino file found for version bumping!")
            else:
                ino_path = ino_files[0]
                print(f"Updating version in: {ino_path}")
                
                with open(ino_path, 'r') as f:
                    content = f.read()
                
                # Regex replace
                content = re.sub(r'#define FIRMWARE_VERSION ".*?"', f'#define FIRMWARE_VERSION "{new_version}"', content)
                
                with open(ino_path, 'w') as f:
                    f.write(content)
            
            # Export to ENV
            with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                env_file.write(f"NEW_VERSION={new_version}\n")
        
        except Exception as e:
            print(f"Error: {e}")
            exit(1)
        EOF
        
        python bump_version.py

    - name: Commit and Push Version Bump
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add version.json
        # Stage .ino file dynamically
        find . -name "*.ino" -exec git add {} \;
        git commit -m "chore: bump version to ${{ env.NEW_VERSION }} [skip ci]"
        git push

    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v2

    - name: Install ESP32 Platform
      run: |
        arduino-cli config init
        arduino-cli core update-index --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        arduino-cli core install esp32:esp32 --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

    - name: Install Libraries
      run: |
        arduino-cli lib install "AccelStepper"
        arduino-cli lib install "ArduinoJson"
        arduino-cli lib install "WiFiManager"
        git clone https://github.com/me-no-dev/AsyncTCP.git ~/Arduino/libraries/AsyncTCP
        git clone https://github.com/me-no-dev/ESPAsyncWebServer.git ~/Arduino/libraries/ESPAsyncWebServer

    - name: Compile Sketch
      run: |
        mkdir -p build
        # Find the .ino file dynamically
        SKETCH_PATH=$(find . -name "*.ino" | head -n 1)
        arduino-cli compile --fqbn esp32:esp32:esp32 --output-dir ./build "$SKETCH_PATH"

    - name: Build LittleFS Image
      run: |
        # Download mklittlefs
        wget https://github.com/earlephilhower/mklittlefs/releases/download/${{ env.MKLITTLEFS_VERSION }}/x86_64-linux-gnu-mklittlefs-${{ env.MKLITTLEFS_VERSION }}.tar.gz
        tar -xzf x86_64-linux-gnu-mklittlefs-${{ env.MKLITTLEFS_VERSION }}.tar.gz
        mv mklittlefs /usr/local/bin/

        # Create LittleFS binary (assuming 1.5MB offset, 0x170000 size - adjust based on partition scheme)
        # Using default partition scheme "default" usually gives ~1.5MB app, ~1.5MB SPIFFS/LittleFS
        # We will create a generic bin, user must ensure partition match.
        # But generally: mklittlefs -c <data_dir> -p <page_size> -b <block_size> -s <partition_size> <output_file>
        # ESP32 Default: Page 256, Block 4096. Size depends on partition table.
        # Let's assume standard 'default' partition: data is at 0x290000, size 0x170000 (approx 1.4MB)
        
        # NOTE: Finding the data directory dynamically
        DATA_PATH=$(find . -type d -name "data" | head -n 1)
        if [ -z "$DATA_PATH" ]; then
           echo "No data directory found, creating empty one for valid bin generation"
           mkdir -p data
           DATA_PATH="data"
        fi
        
        echo "Building LittleFS from $DATA_PATH"
        mklittlefs -c "$DATA_PATH" -p 256 -b 4096 -s 1474560 ./build/HorusByWyntro.littlefs.bin


    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.NEW_VERSION }}
        name: Release ${{ env.NEW_VERSION }}
        files: |
          ./build/*.bin
          ./build/*.littlefs.bin
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Prepare Pages
      run: |
        mkdir -p public
        cp version.json public/
        cp ./build/*.bin public/
        
        # Deploy Website Content
        if [ -d "website" ]; then
           echo "Copying website content..."
           cp -r website/* public/
        else
           echo "Error: 'website' directory not found!"
           exit 1
        fi

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages
